name: Weekly Self-Evolve

on:
  schedule:
    - cron: '45 12 * * SUN'      # every Sunday 12:45 UTC
  workflow_dispatch:

permissions:
  contents: write                # allow the workflow to push / open PRs

jobs:
  evolve:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) Python env
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3) Install deps
      - name: 📦 Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv pyyaml

      # 4) Inject OpenAI key
      - name: 🔐 OpenAI key
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env

      # 5) Generate improvement proposal
      - name: 🤖 Generate improvement proposal
        run: python tools/propose_improvement.py

      # 6) Commit on branch & open PR
      - name: 📬 Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: "auto/self-evolve-${{ github.run_id }}"
          add-paths: |
            proposals/*.md
          commit-message: "🤖 proposal: self-evolve $(date -u +'%Y-%m-%d')"
          title: "🤖 Lucian self-evolve proposal"
          body: |
            Automated self-improvement proposal generated from latest metrics.
            **Please review, edit, or merge.**
          delete-branch: true
